package Libraries.Game.Graphics.Vulkan

use Libraries.Game.Graphics.Vulkan.Commands.VulkanCommand
use Libraries.Containers.Array
use Libraries.Game.Graphics.Vulkan.Commands.all

class VulkanCommandBuffer

    VulkanDevice device = undefined
    VulkanCommandPool commandPool = undefined

    boolean initialized = false

    // TO-DO: REMOVE THIS. For debugging only.
    Array<text> commandNames

    action Create(VulkanDevice device, VulkanCommandPool commandPool) returns boolean
        VulkanConstants constants
        return Create(device, commandPool, constants:COMMAND_BUFFER_LEVEL_PRIMARY)
    end

    action Create(VulkanDevice device, VulkanCommandPool commandPool, integer level) returns boolean
        boolean result = CreateNative(device, commandPool, level)
        
        if result
            me:device = device
            me:commandPool = commandPool

            initialized = true
        end

        return result
    end

    private system action CreateNative(VulkanDevice device, VulkanCommandPool commandPool, integer level) returns boolean

    action Dispose
        alert("NYI")
    end

    /*
    This action resets the command buffer, removing any recorded commands from the buffer. This will also instruct the
    system to release any internal resources it's using for the commands (but not the buffer itself -- for that, use the
    Dispose action instead).
    */
    action Reset
        Reset(true)
    end

    /*
    This action resets the command buffer, removing any recorded commands from the buffer. If the boolean value is true,
    the system will also be instructed to release any internal resources it's using for the commands (but not the buffer itself -- for that, use the
    Dispose action instead). If the value is false, the system may preserve some resources for future use, depending on
    the graphics hardware's implementation.
    */
    system action Reset(boolean releaseResources)

    /*
    This action instructs the buffer to begin recording commands. Commands are recorded using classes that inherit from the "VulkanCommand" class.
    */
    system action BeginRecording returns boolean

    /*
    This action closes the buffer, indicating the end of recorded commands.
    */
    system action EndRecording returns boolean

    /*
    This action will record a command into the command buffer. The command buffer must have already been set using the
    BeginRecording command.
    */
    action Record(VulkanCommand command)
        if command is BeginRenderPassCommand
            commandNames:Add("BeginRenderPassCommand")
        elseif command is BindIndexBufferCommand
            commandNames:Add("BindIndexBufferCommand")
        elseif command is BindPipelineCommand
            commandNames:Add("BindPipelineCommand")
        elseif command is BindVertexBufferCommand
            commandNames:Add("BindVertexBufferCommand")
        elseif command is CopyBufferCommand
            commandNames:Add("CopyBufferCommand")
        elseif command is DrawIndexedCommand
            commandNames:Add("DrawIndexedCommand")
        elseif command is EndRenderPassCommand
            commandNames:Add("EndRenderPassCommand")
        elseif command is PipelineBarrierCommand
            commandNames:Add("PipelineBarrierCommand")
        elseif command is SetScissorCommand
            commandNames:Add("SetScissorCommand")
        elseif command is SetViewportCommand
            commandNames:Add("SetViewportCommand")
        else
            commandNames:Add("Unknown")
        end

        command:Record(me)
    end

    // TO-DO: Remove this
    action DebugOutputNames
        if true
            return now
        end

        integer i = 0
        repeat while i < commandNames:GetSize()
            output i + ": " + commandNames:Get(i)
            i = i + 1
        end
        commandNames:Empty()
    end

end